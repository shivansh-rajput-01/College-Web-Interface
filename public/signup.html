<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>Sign Up</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.5/dist/css/bootstrap.min.css" rel="stylesheet">
</head>

<body class="bg-light">
  <div class="container mt-5">
    <h2 class="text-center mb-4">Sign Up</h2>
    <form id="signupForm" class="mx-auto" style="max-width: 500px;">

      <div class="mb-3">
        <label class="form-label">Register As</label>
        <select id="signupRole" class="form-control" required>
          <option value="" selected disabled>Select Role</option>
          <option value="student">Student</option>
          <option value="teacher">Teacher</option>
        </select>
      </div>

      <div class="mb-3">
        <label class="form-label">Full Name</label>
        <input type="text" id="signupName" class="form-control" required>
      </div>
      <div class="mb-3">
        <label class="form-label">Username</label>
        <input type="text" id="signupUsername" class="form-control" required>
      </div>
      <div class="mb-3">
        <label class="form-label">Email</label>
        <input type="email" id="signupEmail" class="form-control" required>
      </div>
      <div class="mb-3">
        <label class="form-label">Mobile Number</label>
        <input type="tel" id="signupMobile" class="form-control" pattern="[0-9]{10}" required>
      </div>
      <div class="mb-3">
        <label class="form-label">Set Password</label>
        <input type="password" id="signupPassword" class="form-control" placeholder="6-8 chars..." required>
        <small class="text-muted" id="passError" style="color: red !important; display: none;"></small>
      </div>
      <button type="submit" class="btn btn-primary w-100">Register</button>
      <div class="text-center mt-3">
        Already have an account? <a href="login.html">Login here</a>
      </div>
    </form>
  </div>

  <script>
    // --- 1. PASSWORD VALIDATION FUNCTION ---
    function validatePasswordSimple(password) {
      // Length Check
      if (password.length < 6 || password.length > 8) {
        return "Password must be between 6 and 8 characters.";
      }

      let hasUpper = false;
      let hasLower = false;
      let hasNumber = false;
      let hasSpecial = false;
      const specialChars = "!@#$%^&*()_+-=[]{}|;':,.<>?";

      for (let i = 0; i < password.length; i++) {
        let char = password[i];
        if (char >= 'A' && char <= 'Z') hasUpper = true;
        else if (char >= 'a' && char <= 'z') hasLower = true;
        else if (char >= '0' && char <= '9') hasNumber = true;
        else if (specialChars.includes(char)) hasSpecial = true;
      }

      if (!hasUpper) return "Missing Uppercase letter (A-Z)";
      if (!hasLower) return "Missing Lowercase letter (a-z)";
      if (!hasNumber) return "Missing Number (0-9)";
      if (!hasSpecial) return "Missing Special Symbol (@, #, etc.)";

      return "OK";
    }

    // --- 2. SINGLE SUBMIT LISTENER (MERGED) ---
    document.getElementById("signupForm").addEventListener("submit", async function (e) {
      e.preventDefault();

      const password = document.getElementById("signupPassword").value;
      const errorMsg = validatePasswordSimple(password);
      const errorSpan = document.getElementById("passError");

      // STEP 1: VALIDATION CHECK
      if (errorMsg !== "OK") {
        errorSpan.innerText = errorMsg;
        errorSpan.style.display = "block";
        return; // Yahan return kiya toh code yahi ruk jayega, server call nahi hogi.
      } else {
        errorSpan.style.display = "none";
      }

      // STEP 2: AGAR VALIDATION PASS HUA TOH DATA BHEJO
      const formData = {
        role: document.getElementById("signupRole").value,
        name: document.getElementById("signupName").value,
        username: document.getElementById("signupUsername").value,
        email: document.getElementById("signupEmail").value,
        mobile: document.getElementById("signupMobile").value,
        password: password
      };

      try {
        const response = await fetch('/signup', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(formData)
        });

        const result = await response.json();

        if (result.success) {
          alert("Signup Successful! Please Login.");
          window.location.href = 'login.html';
        } else {
          alert(result.message);
        }
      } catch (err) {
        alert("Server Error");
      }
    });
  </script>
</body>

</html>